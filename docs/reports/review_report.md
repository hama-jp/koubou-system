# 工房システム プロジェクトレビューレポート

## 1. 概要

本レポートは、工房システム（Koubou System）の現状のソースコード、ドキュメント、および負荷テストの結果に基づいたレビューです。

## 2. 全体評価

本プロジェクトは「AIエージェントによるタスク処理の自動化と効率化」という明確な目標に向かって、よく構造化されています。特に、タスク量に応じてワーカー数を自動で増減させる動的スケーリング機能は、v1.0の設計書通りに実装されており、プロジェクトのコアコンセプトが機能していることを確認しました。

一方で、負荷テストを通じて、システムのボトルネックや、将来の拡張性に関するいくつかの課題も明らかになりました。

## 3. 評価点

- **明確なアーキテクチャ:** `mcp_server`（タスク受付）、`worker_pool_manager`（ワーカー管理）、`local_worker`（タスク実行）の役割分担が明確で、理解しやすい構造になっています。
- **動的スケーリングの実装:** 負荷テストにおいて、タスクキューの量に応じてワーカープロセスが動的に起動・停止することを確認しました。これは本システムの中心的な機能が正しく動作していることを示します。
- **堅牢性への配慮:** ワーカーのクラッシュを想定したデッドワーカーのクリーンアップ機能や、タスク実行をサブプロセス化するなどの工夫が見られます。

## 4. 課題と改善提案

### 課題1：データベースアクセスの重複と密結合

**現状:**
`mcp_server.py`, `worker_pool_manager.py`, `local_worker.py` の各コンポーネントが、それぞれ個別に `sqlite3` をインポートし、直接データベースに接続・操作しています。これにより、類似のコードが重複し、スキーマ変更時の修正漏れのリスクが高まっています。

**提案:**
データベース操作を専門に担う共通モジュール（例: `common/database.py`）を作成することを強く推奨します。このモジュールにデータベース接続やCRUD操作（作成、読み取り、更新、削除）を集約することで、以下のメリットが期待できます。

- **コードの再利用性向上:** 重複するデータベース関連コードを一元化できます。
- **保守性の向上:** スキーマ変更時の修正箇所が1箇所に集約されます。
- **テストの容易化:** データベース層をモックすることが容易になり、ユニットテストの品質が向上します。

### 課題2：LLMサーバーの性能ボトルネック

**現状:**
負荷テストの結果、多くのタスクがタイムアウトによって失敗しました。ワーカーのログを分析したところ、これはワーカー自体に問題があるのではなく、多数のワーカーから同時にリクエストを受けたOllamaサーバーが処理しきれず、応答を返せなくなっていることが原因です。

**提案:**

- **短期的対策（推奨）:**
  - ワーカープールマネージャーが起動する**最大ワーカー数を、Ollamaサーバーが安定して処理できる数に制限**してください（例: `worker_pool_manager.py --max 8` を `--max 3` や `--max 4` に変更してテストする）。

- **中・長期的対策:**
  - **タイムアウト値の調整:** `local_worker.py` 内の `subprocess.run` のタイムアウト値を長く設定し、より重い処理にも対応できるようにします。
  - **リトライ機構の実装:** タイムアウトが発生した場合、すぐにタスクを失敗とせず、数秒待ってから再試行するロジックをワーカーに追加することで、一時的な高負荷に対する耐性を高めます。
  - **Ollamaサーバーのチューニング:** Ollamaを実行する環境のリソース（特にGPUメモリ）を見直したり、モデルの設定を最適化したりすることを検討します。

### 課題3：将来の拡張性

**現状:**
現在の実装は、OllamaとCodex CLIという特定の実装に密結合しています。将来的に、GPT-4やGeminiなど他のLLMやエージェントを追加する場合、大幅なコード修正が必要になります。

**提案:**
`docs/development/02_design_v2.md` で示されている、より抽象化された設計への移行を計画的に進めることを推奨します。

- **Agent Adapterパターンの導入:** エージェントごとの差異を吸収する `Agent Adapter` を導入し、システムの中核が特定のエージェントに依存しない構造を目指します。
- **標準タスク形式の活用:** `StandardTask` のような共通のデータ構造を定義し、異なるエージェントやワーカー間でタスクを円滑に受け渡せるようにします。

## 5. まとめ

工房システムは、非常に野心的で将来性のあるプロジェクトです。基本的な機能は既に動作しており、そのコンセプトは正しい方向性にあると評価できます。

今後は、本レポートで指摘した**データベースアクセスの共通化**と**性能ボトルネックの解消**に優先的に取り組むことで、システムの安定性と信頼性を大幅に向上させることができるでしょう。その上で、v2.0で描かれているような、より拡張性の高いアーキテクチャへの進化を目指していくことを期待します。
