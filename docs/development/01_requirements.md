# 工房システム要件定義書
## 共通基盤型AIエージェント協調システム

---

## 1. プロジェクト概要

### 1.1 目的
人間とAIが協働し、複雑なタスクを自律的に計画・実行するためのAIエージェントシステムを構築する。親方エージェントは容易に切り替え可能な共通基盤設計とし、実装テストではコスト効率を重視してローカルLLM（gpt-oss-20b）の職人で運用する。

### 1.2 スコープ
- **親方プロセス**: 
  - 主要: Claude Code（対話型タスク管理）
  - 代替: Codex-CLI、Gemini-CLI（共通インターフェース経由で切替可能）
- **職人プロセス**: 
  - 実装テスト: gpt-oss-20bローカル職人のみ
  - 将来拡張: GPT-5等のクラウドLLM追加可能な設計
- **共通基盤**: 
  - エージェント非依存の統一インターフェース
  - SQLiteベースの伝言板システム
  - 標準化されたタスク形式
- **監視・制御**: シェルスクリプトによるオーケストレーション

### 1.3 前提条件
- ローカルPC上でgpt-oss-20bが稼働（LMStudio経由）
- Claude Codeがインストール済み
- Linux/WSL2環境（inotify-tools使用のため）
- Bashシェル環境
- Python 3.8以上（共通基盤実装用）

---

## 2. 機能要件

### 2.1 親方プロセス機能

#### FR-M001: 対話型タスク管理
- **説明**: 人間との対話を通じてタスクを受け取り、計画を立案する
- **入力**: ユーザーからの自然言語指示
- **出力**: タスクリスト、実行計画
- **制約**: Claude Codeまたは選択されたエージェントの対話モードを使用

#### FR-M002: タスク委任判断
- **説明**: タスクの難易度と機密性に基づいて、適切な職人を選択
- **入力**: タスク内容、難易度評価、機密性フラグ
- **出力**: 委任決定、職人選択
- **実装テスト段階の判断基準**:
  - 全タスク → ローカル職人（gpt-oss-20b）
- **将来の判断基準（設計考慮）**:
  - 機密情報を含む → ローカル職人
  - 高難度タスク → クラウドLLM職人（将来実装）
  - 通常タスク → ローカル職人（コスト最適化）

#### FR-M003: 進捗監視
- **説明**: 職人プロセスの実行状況を監視し、必要に応じて介入
- **入力**: 伝言板の状態変更通知
- **出力**: 状態確認、エラー対応指示
- **制約**: リアルタイム性を保証（5秒以内の反応）

### 2.2 職人プロセス機能

#### FR-W001: 非対話型タスク実行
- **説明**: 親方から受け取ったタスクを自律的に実行
- **入力**: タスク定義（JSON形式）
- **出力**: 実行結果、成果物
- **制約**: `--ask-for-approval never`フラグで完全自動実行

#### FR-W002: LLM連携
- **説明**: 割り当てられたLLMと通信してタスクを処理
- **実装テスト仕様**:
  - **ローカル職人**: LMStudio API（gpt-oss-20b）、全タスク対応
- **将来拡張仕様**:
  - クラウドLLM職人: OpenAI API、Gemini API等
- **入力**: プロンプト、コンテキスト
- **出力**: LLMレスポンス、生成コード

#### FR-W003: 状態報告
- **説明**: タスクの進捗と結果を伝言板に記録
- **入力**: 実行状態、エラー情報
- **出力**: SQLiteレコード更新
- **制約**: 最低1分ごとに進捗更新

### 2.3 伝言板システム機能

#### FR-B001: タスク管理
- **説明**: タスクの登録、状態管理、結果保存
- **入力**: タスク情報（CRUD操作）
- **出力**: タスクID、更新確認
- **制約**: SQLite3使用、同時アクセス対応

#### FR-B002: イベント通知
- **説明**: データ変更時に関連プロセスに通知
- **入力**: データ変更イベント
- **出力**: inotify通知、シグナル送信
- **制約**: 遅延1秒以内

#### FR-B003: ログ記録
- **説明**: 全プロセスの活動ログを一元管理
- **入力**: ログエントリ
- **出力**: タイムスタンプ付きログ
- **制約**: ログローテーション（100MB/ファイル）

### 2.4 共通基盤機能

#### FR-C001: エージェント抽象化レイヤー
- **説明**: 異なる親方エージェントを統一インターフェースで操作
- **入力**: 標準化されたタスク定義
- **出力**: エージェント固有のコマンド
- **対応エージェント**: Claude Code、Codex-CLI、Gemini-CLI

#### FR-C002: タスク形式標準化
- **説明**: エージェント間で共通のタスク形式を定義
- **入力**: 生のタスク要求
- **出力**: JSON形式の標準タスク
- **形式**: task_id、type、priority、content、context

### 2.5 オーケストレーション機能

#### FR-O001: プロセス起動管理
- **説明**: 親方・職人プロセスの起動と終了を管理
- **入力**: 起動コマンド、設定ファイル
- **出力**: プロセスID、起動状態
- **制約**: systemd互換、自動再起動対応

#### FR-O002: リソース監視
- **説明**: CPU、メモリ、ディスク使用状況を監視
- **入力**: システムメトリクス
- **出力**: アラート、自動調整
- **制約**: 閾値超過時の自動対応

---

## 3. 非機能要件

### 3.1 性能要件

#### NFR-P001: レスポンスタイム
- **要件**: 親方の対話応答は3秒以内
- **測定方法**: 入力から初回応答までの時間
- **根拠**: ユーザビリティ確保

#### NFR-P002: スループット
- **要件**: 同時に5つまでの職人プロセスを実行可能
- **測定方法**: 並行実行プロセス数
- **根拠**: 一般的なPCリソースの制約

#### NFR-P003: リソース使用量
- **要件**: 
  - メモリ: 親方500MB以下、職人各1GB以下
  - CPU: 全体で80%以下
- **測定方法**: topコマンドでの監視
- **根拠**: 他アプリケーションとの共存

### 3.2 信頼性要件

#### NFR-R001: 可用性
- **要件**: 99%以上（計画停止除く）
- **測定方法**: 稼働時間/全時間
- **根拠**: 開発作業への影響最小化

#### NFR-R002: エラー処理
- **要件**: 全エラーをログ記録し、適切にリカバリ
- **測定方法**: エラーログ監査
- **根拠**: デバッグ容易性

#### NFR-R003: データ整合性
- **要件**: 伝言板データの不整合発生率0.1%以下
- **測定方法**: 定期的な整合性チェック
- **根拠**: システム信頼性確保

### 3.3 セキュリティ要件

#### NFR-S001: データ保護
- **要件**: 機密情報はローカル処理に限定
- **実装**: 
  - タスク分類とルーティング制御
  - 機密データ検出機能（正規表現パターンマッチング）
  - APIキーの安全な管理（環境変数、暗号化設定ファイル）
- **検証**: 監査ログでの確認

#### NFR-S002: アクセス制御
- **要件**: プロセス間通信の認証
- **実装**: Unix権限、ファイルパーミッション
- **検証**: 権限テスト

#### NFR-S003: 監査証跡
- **要件**: 全操作の監査ログ記録（90日保持）
- **実装**: 構造化ログ、ローテーション
- **検証**: ログ完全性チェック

### 3.4 保守性要件

#### NFR-M001: モジュール性
- **要件**: 各コンポーネントの独立性確保
- **実装**: 明確なインターフェース定義
- **検証**: 結合度メトリクス

#### NFR-M002: 拡張性
- **要件**: 新規職人タイプの追加が容易
- **実装**: プラグイン機構
- **検証**: 拡張テスト

#### NFR-M003: デバッグ性
- **要件**: 問題の特定が30分以内
- **実装**: 詳細ログ、トレーシングID
- **検証**: 障害対応訓練

---

## 4. 制約事項

### 4.1 技術的制約
- **LLM制約**: 
  - gpt-oss-20b: コンテキスト長8192トークン
  - 将来クラウドLLM: APIプロバイダーの制限に準じる
- **API制約**: 
  - LMStudio OpenAI互換API（ローカルLLM用）
  - 将来: 各クラウドプロバイダーAPI
- **OS制約**: Linux/WSL2環境必須（inotify使用）

### 4.2 運用制約
- **リソース制約**: 
  - RAM: 最小16GB推奨32GB
  - GPU: VRAM 12GB以上（gpt-oss-20b用）
- **ネットワーク制約**: 
  - ローカルLLMは内部ネットワークのみ
  - 将来クラウドLLM使用時はインターネット接続必須
- **コスト制約**:
  - 実装テスト: ローカル実行のため電力コストのみ
  - 将来: クラウドAPI使用時は従量課金

### 4.3 ライセンス制約
- **Claude Code**: Anthropic利用規約に準拠
- **gpt-oss-20b**: オープンソースライセンス
- **代替エージェント**: 各プロバイダーのライセンスに準拠

---

## 5. 外部インターフェース

### 5.1 ユーザーインターフェース
- **CLI**: Claude Codeまたは選択したエージェントのCLI
- **Web UI**: 監視ダッシュボード（将来実装）

### 5.2 システムインターフェース

#### 5.2.1 LMStudio API (Local)
```yaml
endpoint: http://localhost:1234/v1
authentication: none (local only)
format: OpenAI Compatible API
model: gpt-oss-20b
methods:
  - /chat/completions
  - /models
```

#### 5.2.2 SQLite伝言板
```sql
-- タスクテーブル
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY,
    type TEXT NOT NULL,
    status TEXT NOT NULL,
    assigned_to TEXT,
    priority INTEGER,
    payload JSON,
    result JSON,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- ログテーブル
CREATE TABLE logs (
    id INTEGER PRIMARY KEY,
    task_id INTEGER,
    process_name TEXT,
    level TEXT,
    message TEXT,
    timestamp TIMESTAMP
);
```

#### 5.2.3 プロセス間通信
- **ファイルシステム**: `/var/koubou/tasks/`
- **シグナル**: SIGUSR1（通知）、SIGTERM（終了）
- **inotify**: ファイル変更監視

---

## 6. 用語定義

| 用語 | 定義 |
|------|------|
| 親方プロセス | タスク管理と人間との対話を担当するメインプロセス（Claude Code等） |
| 職人プロセス | 特定タスクを自律的に実行するワーカープロセス |
| 伝言板 | プロセス間で情報を共有するSQLiteデータベース |
| タスク | 実行すべき作業の単位 |
| gpt-oss-20b | ローカルで動作する20Bパラメータの言語モデル |
| LMStudio | ローカルLLMを実行するためのGUIアプリケーション |

---

## 7. 受け入れ基準

### 7.1 機能テスト
- [ ] 親方が対話的にタスクを受け取れる
- [ ] ローカル職人がタスクを自動実行できる
- [ ] 伝言板を通じた状態共有が機能する
- [ ] エラー時の自動リカバリが動作する

### 7.2 性能テスト
- [ ] レスポンスタイムが要件を満たす
- [ ] 5つの職人を同時実行できる
- [ ] メモリ使用量が制限内

### 7.3 統合テスト
- [ ] End-to-Endでタスク実行が完了する
- [ ] 異常系シナリオで適切に動作する
- [ ] 24時間連続稼働が可能

---

## 8. リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| Claude Codeの仕様変更 | 高 | 低 | 共通インターフェースで抽象化、代替エージェント準備 |
| LMStudio APIの仕様変更 | 高 | 低 | APIバージョン固定、抽象化層の実装 |
| gpt-oss-20bのメモリ不足 | 高 | 中 | スワップ設定、コンテキスト長制限 |
| SQLite同時アクセス問題 | 中 | 中 | WALモード使用、リトライ機構 |
| プロセス間通信の遅延 | 低 | 低 | タイムアウト設定、非同期処理 |
| 将来クラウドAPIコスト | 中 | 中 | 予算管理、ローカル優先ポリシー |

---

## 9. 今後の拡張計画

### フェーズ2
- クラウドLLM職人の追加（Gemini API）
- MCPサーバーによる外部連携
- Webダッシュボードの実装

### フェーズ3
- マルチエージェント協調機能
- 自動学習・改善機能
- プラグインシステム

---

## 改訂履歴

| 版 | 日付 | 変更内容 | 作成者 |
|----|------|----------|--------|
| 1.0 | 2024-12-29 | 初版作成 | AI Assistant |