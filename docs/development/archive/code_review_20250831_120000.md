# コードレビューレポート (`.koubou/scripts/`)

**レビュー日時:** 2025年8月31日

## 概要

`.koubou/scripts/` ディレクトリ内のスクリプト群は、工房システムの中核をなす重要なコンポーネントです。全体として、モジュール化が進んでおり、各スクリプトが特定の責務を持っている点は評価できます。特に、分散システム（`distributed/`）、データベース管理（`common/database.py`）、ワーカー管理（`workers/`）など、機能ごとに整理されています。

しかし、いくつかの領域で改善の余地が見られます。主な改善点は以下の通りです。

1.  **設定管理の一元化**: APIエンドポイントやパスなどの設定値が各スクリプトにハードコードされており、変更に弱くなっています。
2.  **エラーハンドリングの強化**: `try-except` ブロックが広範囲をカバーしすぎており、具体的なエラー処理が不足している箇所があります。
3.  **セキュリティ**: シェルスクリプトやサブプロセス呼び出しにおいて、インジェクションのリスクが残っています。
4.  **依存関係の管理**: `uv` や `pip` を直接実行するのではなく、`pyproject.toml` や `requirements.txt` を用いた依存関係管理が望ましいです。
5.  **コードの重複**: `gemini-exec.sh` と `gemini-repo-exec.sh` のように、内容がほぼ同一のスクリプトが存在します。

以下に、主要なスクリプトごとの詳細なレビューを記載します。

---

## 1. 主要スクリプトレビュー

### `common/database.py`

-   **評価 (Good)**: SQLiteの接続プールやWALモードの活用、リトライ処理など、パフォーマンスと堅牢性を高めるための工夫が見られます。インデックスも適切に設定されています。
-   **改善点**:
    -   **トランザクション管理**: `create_task` 内で `BEGIN IMMEDIATE` と `COMMIT`/`ROLLBACK` を手動で実行していますが、`with self.get_connection() as conn:` の中で `conn.commit()` を呼び出す形に統一した方が、コンテキストマネージャの意図と合致します。
    -   **エラーロギング**: `logger.error(f"Failed to ...: {e}")` の形式が多いですが、スタックトレースも併せて記録すると、デバッグがより容易になります。

### `distributed/` ディレクトリ

-   **評価 (Good)**: `master_node.py`, `remote_worker_node.py`, `message_queue.py` を中心とした分散システムアーキテクチャはよく設計されています。Pub/Subモデルによる疎結合な通信はスケーラビリティを高めます。
-   **改善点**:
    -   **設定のハードコード**: `master_host`, `queue_type` などがスクリプト内や引数で渡されており、一元管理されていません。設定ファイル（例: `config.yaml`）を導入し、そこから読み込む形式を推奨します。
    -   **メッセージ形式**: メッセージの形式がDictで定義されていますが、`TypedDict` や `Pydantic` を用いてスキーマを定義すると、型安全性が向上し、予期せぬエラーを防げます。


### `graphql_server.py`

-   **評価 (Good)**: `Ariadne` を用いたGraphQLサーバーは、柔軟なデータ取得インターフェースを提供しており、システムの監視や操作に非常に有用です。スキーマ定義も明確です。
-   **改善点**:
    -   **N+1問題**: `resolve_tasks` のようなリゾルバで、ループ内でDBクエリを実行するとパフォーマンスが劣化する可能性があります。`DataLoader` パターンを導入し、クエリをバッチ処理することを検討してください。

---

## 2. 全体的な改善提案

1.  **設定の一元管理**:
    -   プロジェクトルートに `config.yaml` や `.env` ファイルを配置し、データベースパス、APIエンドポイント、ログレベルなどの設定をそこに集約します。各スクリプトは起動時にこの設定ファイルを読み込むように変更します。

2.  **セキュリティ強化**:
    -   `local_worker.py` でのファイル操作は、許可されたディレクトリ内でのみ行われるように厳格なパス検証を追加します。
    -   シェルスクリプトでの変数展開は、常にダブルクォートで囲み、意図しない挙動を防ぎます。

---

以上が今回のコードレビューの結果です。これらの点を改善することで、システムの保守性、堅牢性、安全性がさらに向上すると期待されます。
